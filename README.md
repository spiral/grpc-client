# gRPC Client

PHP gRPC client.

## Installation

```bash
composer require spiral/grpc-client -W
```

[![PHP](https://img.shields.io/packagist/php-v/spiral/grpc-client.svg?style=flat-square&logo=php)](https://packagist.org/packages/spiral/grpc-client)
[![Latest Version on Packagist](https://img.shields.io/packagist/v/spiral/grpc-client.svg?style=flat-square&logo=packagist)](https://packagist.org/packages/spiral/grpc-client)
[![License](https://img.shields.io/packagist/l/spiral/grpc-client.svg?style=flat-square)](LICENSE.md)
[![Total downloads](https://img.shields.io/packagist/dt/spiral/grpc-client.svg?style=flat-square)](https://packagist.org/packages/spiral/grpc-client/stats)

## Usage

### Public API

The package provides the following parts of the API:
- Integration classes for use with frameworks.
- Classes for convenient package configuration through DTOs.
- A set of basic [interceptors](https://spiral.dev/docs/framework-interceptors/).
- Several types of exceptions for error handling.

### Integration and Configuration

First of all, you need to integrate the package into your application.

#### Spiral

> [!NOTE]
> The [`spiral/roadrunner-bridge`](https://github.com/spiral/roadrunner-bridge) package includes
> the `spiral/grpc-client` package by default since version `4.0.0` and provides its integration
> and configuration flow.

Add the `\Spiral\Grpc\Client\Bridge\GrpcClientBootloader` bootloader to the list of bootloaders
in the application configuration (usually it is `Kernel.php`).

#### Other Frameworks

If you are using this package outside the [Spiral](https://spiral.dev/) framework,
you have to think yourself about how to use the `\Spiral\Grpc\Client\ServiceClientProvider` provider
to get ready-to-use gRPC clients.

#### Configuration DTOs

Now let's consider a configuration example:

```php
use Spiral\Grpc\Client\Config\GrpcClientConfig;
use Spiral\Grpc\Client\Config\ServiceConfig;
use Spiral\Grpc\Client\Config\ConnectionConfig;
use Spiral\Grpc\Client\Interceptor\SetTimoutInterceptor;
use Spiral\Grpc\Client\Interceptor\RetryInterceptor;
use Spiral\Grpc\Client\Interceptor\ExecuteServiceInterceptors;

new GrpcClientConfig(
    interceptors: [
        SetTimoutInterceptor::createConfig(10_000), // 10 seconds
        RetryInterceptor::createConfig(
            maximumAttempts: 3,
            initialInterval: 100, // 0.1 seconds
            backoffCoefficient: 1.5,
        ),
        ExecuteServiceInterceptors::class,
    ],
    services: [
        new ServiceConfig(
            connections: ConnectionConfig::createInsecure('my-service:9001'),
            interfaces: [
                \GRPC\MyService\MailSenderInterface::class
                \GRPC\MyService\BlackListInterface::class
                \GRPC\MyService\SubscriberInterface::class
            ],
        ),
    ],
)
```

**GrpcClientConfig**

This class represents the configuration of the gRPC client in general.
Includes a list of services configurations and a general list of interceptors that will be applied to all the services.

Interceptors can be declared as class names, `Spiral\Core\Container\Autowire` objects
(if custom constructor arguments need to be passed), or objects.
Note that some interceptors provide convenient methods for creating configurations.

**ServiceConfig**

This class represents the configuration of a specific service or a group of same services
but with different connection options.

The `interfaces` parameter is a list of gRPC service interfaces that were generated by the `protoc` utility
and that are implemented by the service.

> [!NOTE]
> Currently, we support only service interfaces that are [generated](https://spiral.dev/docs/grpc-client)
> using the `protoc` utility with the `protoc-gen-php-grpc` plugin.

The configuration example above doesn't include the `interceptors` parameter.
It's the same as in the general configuration, but it's applied only to the specified service.
This branch of interceptors is run via the `ExecuteServiceInterceptors` interceptor.
So, it's important to include it if you want to use service-specific interceptors.

The `connections` parameter is a list of connection configurations. You can specify multiple connections
to distribute the load between them or to provide fail-over.
Multi-connection orchestration strategy can be configured by interceptors,
for example, `ConnectionsRotationInterceptor`.

**ConnectionConfig**

This class represents the configuration of a single connection to the gRPC service.
Includes credentials and the service address.
Use static methods to create connection configurations with different types of credentials.

### Interceptors

Important points when using interceptors in the [long-running](https://spiral.dev/docs/start-server) mode:
- **Stateful**: interceptors are recreated anew for each request, so you can safely store the state of each call.
- **Scoped**: interceptors are created in the same Container Scope in which the client is called.
  Accordingly, you can request contextual dependencies in the interceptor's constructor.

#### Order of Interceptors

Interceptors are executed in the order in which they are declared in the configuration.
The order of the interceptors is important.

For example, if we have the following configuration:

1. `SetTimout(10 seconds)`
2. `Retry(maxAttempts: 3, interval: 2 seconds)`
3. `SetTimout(3 second)`

then we will have `3 second` timeout for each attempt of the retry.  
We also have a 10-second timeout for all attempts in total, after which **no new request** attempts will be made.
It happens because the `RetryInterceptor` takes into account configured earlier timeouts.

Also, the placement of the `ExecuteServiceInterceptors` interceptor,
which embeds the interceptors of the currently running service,
will affect the final sequence of interceptors.
